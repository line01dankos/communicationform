<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communication Form</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      width: 100%;
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    .app-container {
      width: 100%;
      min-height: 100%;
      background: #f7fafc;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 100%;
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e2e8f0;
      padding: 0 24px;
      width: 100%;
    }
    
    .tab {
      padding: 16px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 500;
      color: #64748b;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #667eea;
      background: #f8fafc;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
      padding: 24px;
      width: 100%;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .filter-section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      font-weight: 500;
      color: #334155;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-card.total::before {
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-card.open::before {
      background: linear-gradient(90deg, #f59e0b, #ef4444);
    }
    
    .stat-card.closed::before {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    
    .stat-card.machines::before {
      background: linear-gradient(90deg, #3b82f6, #2563eb);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }
    
    .chart-container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8fafc;
    }
    
    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: #475569;
      font-size: 14px;
      white-space: nowrap;
    }
    
    td {
      padding: 16px;
      border-top: 1px solid #e2e8f0;
      font-size: 14px;
      color: #334155;
    }
    
    tr:hover {
      background: #f8fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge.open {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge.closed {
      background: #d1fae5;
      color: #065f46;
    }
    
    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .thumbnail:hover {
      transform: scale(1.05);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }
    
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    
    .close-btn:hover {
      background: #f1f5f9;
    }
    
    .timeline {
      position: relative;
      padding-left: 40px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e2e8f0;
    }
    
    .timeline-item {
      position: relative;
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -33px;
      top: 24px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #667eea;
      border: 3px solid white;
      box-shadow: 0 0 0 2px #667eea;
    }
    
    .timeline-time {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 8px;
    }
    
    .timeline-action {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    
    .timeline-details {
      font-size: 14px;
      color: #475569;
    }
    
    .file-upload {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-upload:hover {
      border-color: #667eea;
      background: #f8fafc;
    }
    
    .file-upload input {
      display: none;
    }
    
    .preview-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 12px;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    
    .notification.show {
      display: flex;
    }
    
    .notification.success {
      border-left: 4px solid #10b981;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
    
    .progress-bar {
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      transition: width 0.3s ease;
    }

    .image-preview-modal .modal-content {
      max-width: 90%;
      padding: 0;
      background: transparent;
    }

    .image-preview-modal img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container">
   <div class="header">
    <h1 id="app-title">Communication Form</h1>
   </div>
   <div class="tabs"><button class="tab active" data-tab="dashboard"> üìä <span id="dashboard-tab">Dashboard</span> </button> <button class="tab" data-tab="input"> üìù <span id="input-tab">Input Data</span> </button> <button class="tab" data-tab="history"> üìú <span id="history-tab">History</span> </button>
   </div><!-- Dashboard Tab -->
   <div class="tab-content active" id="dashboard">
    <div class="filter-section">
     <h3 style="margin: 0 0 16px 0; color: #1e293b;">Filter Data</h3>
     <div class="filter-grid">
      <div class="form-group"><label for="filter-mesin">Nama Mesin</label> <select id="filter-mesin"> <option value="">Semua Mesin</option> </select>
      </div>
      <div class="form-group"><label for="filter-start">Tanggal Mulai</label> <input type="date" id="filter-start">
      </div>
      <div class="form-group"><label for="filter-end">Tanggal Akhir</label> <input type="date" id="filter-end">
      </div>
      <div class="form-group"><label for="filter-operator">Operator</label> <select id="filter-operator"> <option value="">Semua Operator</option> </select>
      </div>
      <div class="form-group"><label for="filter-status">Status</label> <select id="filter-status"> <option value="">Semua Status</option> <option value="open">Open</option> <option value="closed">Closed</option> </select>
      </div>
     </div>
    </div>
    <div class="stats-grid">
     <div class="stat-card total">
      <div class="stat-value" id="stat-total">
       0
      </div>
      <div class="stat-label">
       Total Temuan
      </div>
     </div>
     <div class="stat-card open">
      <div class="stat-value" id="stat-open">
       0
      </div>
      <div class="stat-label">
       Total Open
      </div>
     </div>
     <div class="stat-card closed">
      <div class="stat-value" id="stat-closed">
       0
      </div>
      <div class="stat-label">
       Total Closed
      </div>
     </div>
     <div class="stat-card machines">
      <div class="stat-value" id="stat-machines">
       0
      </div>
      <div class="stat-label">
       Total Mesin Terinput
      </div>
     </div>
    </div>
    <div class="chart-container">
     <div class="chart-title">
      Temuan per Mesin
     </div>
     <canvas id="chart-mesin"></canvas>
    </div>
    <div class="chart-container">
     <div class="chart-title">
      Persentase Closed per Mesin
     </div>
     <div id="progress-container"></div>
    </div>
    <div class="chart-container">
     <div class="chart-title">
      Operator vs Temuan
     </div>
     <canvas id="chart-operator"></canvas>
    </div>
    <div class="table-container">
     <div class="table-wrapper">
      <table>
       <thead>
        <tr>
         <th>Status</th>
         <th>Tanggal Temuan</th>
         <th>Updated At</th>
         <th>Nama Mesin</th>
         <th>Operator</th>
         <th>Kategori</th>
         <th>Item Temuan</th>
         <th>Dampak</th>
         <th>Saran</th>
         <th>Action</th>
         <th>PIC</th>
         <th>Foto Before</th>
         <th>Foto After</th>
         <th>Aksi</th>
        </tr>
       </thead>
       <tbody id="table-body">
       </tbody>
      </table>
     </div>
    </div>
   </div><!-- Input Tab -->
   <div class="tab-content" id="input">
    <div class="filter-section">
     <h3 style="margin: 0 0 24px 0; color: #1e293b;">Tambah Temuan Baru</h3>
     <form id="input-form">
      <div class="filter-grid">
       <div class="form-group"><label for="input-mesin">Nama Mesin *</label> <select id="input-mesin" required> <option value="">Pilih Mesin</option> </select>
       </div>
       <div class="form-group"><label for="input-mesin-baru">Atau Tambah Mesin Baru</label> <input type="text" id="input-mesin-baru" placeholder="Nama mesin baru">
       </div>
       <div class="form-group"><label for="input-operator">Operator *</label> <input type="text" id="input-operator" required placeholder="Nama operator" style="text-transform: uppercase;">
       </div>
       <div class="form-group"><label for="input-kategori">Kategori *</label> <select id="input-kategori" required> <option value="">Pilih Kategori</option> <option value="Quality">Quality</option> <option value="Productivity">Productivity</option> <option value="Safety">Safety</option> <option value="5R">5R</option> </select>
       </div>
      </div>
      <div class="form-group" style="margin-top: 16px;"><label for="input-item">Item Temuan *</label> <textarea id="input-item" required placeholder="Deskripsi item temuan"></textarea>
      </div>
      <div class="form-group"><label for="input-dampak">Dampak Masalah *</label> <textarea id="input-dampak" required placeholder="Dampak dari masalah ini"></textarea>
      </div>
      <div class="form-group"><label for="input-saran">Saran Action *</label> <textarea id="input-saran" required placeholder="Saran tindakan perbaikan"></textarea>
      </div>
      <div class="form-group"><label>Foto Before *</label>
       <div class="file-upload" onclick="document.getElementById('input-foto').click()"><input type="file" id="input-foto" accept="image/*" required>
        <div>
         üì∑ Klik untuk upload foto
        </div><img id="preview-before" class="preview-image" style="display: none;">
       </div>
      </div>
      <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button> <button type="submit" class="btn btn-primary">üíæ Simpan Temuan</button>
      </div>
     </form>
    </div>
   </div><!-- History Tab -->
   <div class="tab-content" id="history">
    <div class="filter-section">
     <h3 style="margin: 0 0 24px 0; color: #1e293b;">Riwayat Aktivitas</h3>
     <div class="timeline" id="timeline-container">
     </div>
    </div>
   </div>
  </div><!-- Update Modal -->
  <div class="modal" id="update-modal">
   <div class="modal-content">
    <div class="modal-header">
     <div class="modal-title">
      Update Temuan
     </div><button class="close-btn" onclick="closeUpdateModal()">√ó</button>
    </div>
    <form id="update-form"><input type="hidden" id="update-id">
     <div class="form-group"><label for="update-action">Action yang Dilakukan *</label> <textarea id="update-action" required placeholder="Tindakan yang sudah dilakukan"></textarea>
     </div>
     <div class="form-group"><label>Foto After *</label>
      <div class="file-upload" onclick="document.getElementById('update-foto').click()"><input type="file" id="update-foto" accept="image/*" required>
       <div>
        üì∑ Klik untuk upload foto
       </div><img id="preview-after" class="preview-image" style="display: none;">
      </div>
     </div>
     <div class="form-group"><label for="update-pic">Inisial PIC *</label> <input type="text" id="update-pic" required placeholder="Inisial penanggung jawab" style="text-transform: uppercase;">
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeUpdateModal()">Batal</button> <button type="submit" class="btn btn-success">‚úÖ Close Temuan</button>
     </div>
    </form>
   </div>
  </div><!-- Image Preview Modal -->
  <div class="modal image-preview-modal" id="image-modal">
   <div class="modal-content"><img id="modal-image" src="">
   </div>
  </div><!-- Notification -->
  <div class="notification" id="notification"><span id="notification-text"></span>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Communication Form",
      dashboard_tab_label: "Dashboard",
      input_tab_label: "Input Data",
      history_tab_label: "History"
    };

    const config = defaultConfig;

    async function onConfigChange(cfg) {
      document.getElementById('app-title').textContent = cfg.app_title || defaultConfig.app_title;
      document.getElementById('dashboard-tab').textContent = cfg.dashboard_tab_label || defaultConfig.dashboard_tab_label;
      document.getElementById('input-tab').textContent = cfg.input_tab_label || defaultConfig.input_tab_label;
      document.getElementById('history-tab').textContent = cfg.history_tab_label || defaultConfig.history_tab_label;
    }

    function mapToCapabilities(cfg) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ["app_title", cfg.app_title || defaultConfig.app_title],
        ["dashboard_tab_label", cfg.dashboard_tab_label || defaultConfig.dashboard_tab_label],
        ["input_tab_label", cfg.input_tab_label || defaultConfig.input_tab_label],
        ["history_tab_label", cfg.history_tab_label || defaultConfig.history_tab_label]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Supabase Configuration
    const SUPABASE_URL = 'https://khhcvjlzofasbamfbodr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoaGN2amx6b2Zhc2JhbWZib2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDg1MjgsImV4cCI6MjA4MDMyNDUyOH0.c4F_FAnMwh6yMDpR-jFRoxnJ7oMpzmnGrqAGucHKa6Q';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allData = [];
    let chartMesin = null;
    let chartOperator = null;
    
    // Tab Navigation
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(targetTab).classList.add('active');
        
        if (targetTab === 'history') {
          loadHistory();
        }
      });
    });
    
    // Initialize
    async function init() {
      await loadData();
      await loadMachineOptions();
      setupEventListeners();
    }
    
    async function loadData() {
      try {
        const { data, error } = await supabase
          .from('temuan')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allData = data || [];
        updateDashboard();
      } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Gagal memuat data');
      }
    }
    
    async function loadMachineOptions() {
      const machines = [...new Set(allData.map(d => d.nama_mesin))].sort();
      const selectElements = [
        document.getElementById('filter-mesin'),
        document.getElementById('input-mesin')
      ];
      
      selectElements.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Pilih Mesin</option>';
        machines.forEach(machine => {
          const option = document.createElement('option');
          option.value = machine;
          option.textContent = machine;
          select.appendChild(option);
        });
        select.value = currentValue;
      });
    }
    
    function setupEventListeners() {
      // Filters
      ['filter-mesin', 'filter-start', 'filter-end', 'filter-operator', 'filter-status'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateDashboard);
      });
      
      // File uploads
      document.getElementById('input-foto').addEventListener('change', function(e) {
        handleFileUpload(e, 'preview-before');
      });
      
      document.getElementById('update-foto').addEventListener('change', function(e) {
        handleFileUpload(e, 'preview-after');
      });
      
      // Forms
      document.getElementById('input-form').addEventListener('submit', handleSubmitTemuan);
      document.getElementById('update-form').addEventListener('submit', handleUpdateTemuan);
      
      // Image modal close
      document.getElementById('image-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    }
    
    function updateDashboard() {
      const filtered = getFilteredData();
      
      // Update stats
      document.getElementById('stat-total').textContent = filtered.length;
      document.getElementById('stat-open').textContent = filtered.filter(d => d.status === 'open').length;
      document.getElementById('stat-closed').textContent = filtered.filter(d => d.status === 'closed').length;
      document.getElementById('stat-machines').textContent = new Set(filtered.map(d => d.nama_mesin)).size;
      
      // Update operator filter
      const operators = [...new Set(allData.map(d => d.operator))].sort();
      const operatorSelect = document.getElementById('filter-operator');
      const currentOperator = operatorSelect.value;
      operatorSelect.innerHTML = '<option value="">Semua Operator</option>';
      operators.forEach(op => {
        const option = document.createElement('option');
        option.value = op;
        option.textContent = op;
        operatorSelect.appendChild(option);
      });
      operatorSelect.value = currentOperator;
      
      // Update charts
      updateCharts(filtered);
      
      // Update table
      updateTable(filtered);
    }
    
    function getFilteredData() {
      let filtered = [...allData];
      
      const mesin = document.getElementById('filter-mesin').value;
      const start = document.getElementById('filter-start').value;
      const end = document.getElementById('filter-end').value;
      const operator = document.getElementById('filter-operator').value;
      const status = document.getElementById('filter-status').value;
      
      if (mesin) {
        filtered = filtered.filter(d => d.nama_mesin === mesin);
      }
      if (start) {
        filtered = filtered.filter(d => d.tanggal_temuan >= start);
      }
      if (end) {
        filtered = filtered.filter(d => d.tanggal_temuan <= end);
      }
      if (operator) {
        filtered = filtered.filter(d => d.operator === operator);
      }
      if (status) {
        filtered = filtered.filter(d => d.status === status);
      }
      
      return filtered;
    }
    
    function updateCharts(data) {
      // Chart: Temuan per Mesin
      const mesinData = {};
      data.forEach(d => {
        mesinData[d.nama_mesin] = (mesinData[d.nama_mesin] || 0) + 1;
      });
      
      const mesinLabels = Object.keys(mesinData);
      const mesinValues = Object.values(mesinData);
      
      if (chartMesin) {
        chartMesin.destroy();
      }
      
      const ctxMesin = document.getElementById('chart-mesin').getContext('2d');
      chartMesin = new Chart(ctxMesin, {
        type: 'bar',
        data: {
          labels: mesinLabels,
          datasets: [{
            label: 'Jumlah Temuan',
            data: mesinValues,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
      
      // Progress bars: Closed per Mesin
      const progressContainer = document.getElementById('progress-container');
      progressContainer.innerHTML = '';
      
      mesinLabels.forEach(mesin => {
        const total = data.filter(d => d.nama_mesin === mesin).length;
        const closed = data.filter(d => d.nama_mesin === mesin && d.status === 'closed').length;
        const percentage = total > 0 ? Math.round((closed / total) * 100) : 0;
        
        const progressItem = document.createElement('div');
        progressItem.style.marginBottom = '16px';
        progressItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #334155;">${mesin}</span>
            <span style="color: #64748b;">${closed}/${total}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%">${percentage}%</div>
          </div>
        `;
        progressContainer.appendChild(progressItem);
      });
      
      // Chart: Operator vs Temuan
      const operatorData = {};
      data.forEach(d => {
        operatorData[d.operator] = (operatorData[d.operator] || 0) + 1;
      });
      
      const operatorLabels = Object.keys(operatorData);
      const operatorValues = Object.values(operatorData);
      
      if (chartOperator) {
        chartOperator.destroy();
      }
      
      const ctxOperator = document.getElementById('chart-operator').getContext('2d');
      chartOperator = new Chart(ctxOperator, {
        type: 'bar',
        data: {
          labels: operatorLabels,
          datasets: [{
            label: 'Jumlah Temuan',
            data: operatorValues,
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    function updateTable(data) {
      const tbody = document.getElementById('table-body');
      
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="14">
              <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                <div style="font-size: 16px; font-weight: 600;">Tidak ada data</div>
                <div style="font-size: 14px; margin-top: 8px;">Belum ada temuan yang tercatat</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map(row => {
        const updatedAt = row.updated_at ? new Date(row.updated_at).toLocaleString('id-ID') : '-';
        const tanggal = new Date(row.tanggal_temuan).toLocaleDateString('id-ID');
        
        return `
          <tr>
            <td><span class="badge ${row.status}">${row.status.toUpperCase()}</span></td>
            <td>${tanggal}</td>
            <td>${updatedAt}</td>
            <td>${row.nama_mesin}</td>
            <td>${row.operator}</td>
            <td>${row.kategori_temuan}</td>
            <td>${row.item_temuan}</td>
            <td>${row.dampak_masalah}</td>
            <td>${row.saran_action}</td>
            <td>${row.action || '-'}</td>
            <td>${row.inisial_pic || '-'}</td>
            <td>${row.foto_before ? `<img src="${row.foto_before}" class="thumbnail" onclick="showImage('${row.foto_before}')">` : '-'}</td>
            <td>${row.foto_after ? `<img src="${row.foto_after}" class="thumbnail" onclick="showImage('${row.foto_after}')">` : '-'}</td>
            <td>${row.status === 'open' ? `<button class="btn btn-success" onclick="openUpdateModal('${row.id}')">Update</button>` : '-'}</td>
          </tr>
        `;
      }).join('');
    }
    
    function handleFileUpload(event, previewId) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          const maxSize = 800;
          
          if (width > height && width > maxSize) {
            height = (height * maxSize) / width;
            width = maxSize;
          } else if (height > maxSize) {
            width = (width * maxSize) / height;
            height = maxSize;
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          const compressed = canvas.toDataURL('image/jpeg', 0.7);
          document.getElementById(previewId).src = compressed;
          document.getElementById(previewId).style.display = 'block';
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    async function handleSubmitTemuan(e) {
      e.preventDefault();
      
      const mesinSelect = document.getElementById('input-mesin').value;
      const mesinBaru = document.getElementById('input-mesin-baru').value.trim();
      const namaMesin = mesinBaru || mesinSelect;
      
      if (!namaMesin) {
        showNotification('Pilih mesin atau masukkan nama mesin baru');
        return;
      }
      
      const operator = document.getElementById('input-operator').value.toUpperCase();
      const kategori = document.getElementById('input-kategori').value;
      const item = document.getElementById('input-item').value;
      const dampak = document.getElementById('input-dampak').value;
      const saran = document.getElementById('input-saran').value;
      const fotoBefore = document.getElementById('preview-before').src;
      
      if (!fotoBefore || fotoBefore === window.location.href) {
        showNotification('Foto before harus diupload');
        return;
      }
      
      const id = 'TMN-' + Date.now();
      const tanggal = new Date().toISOString().split('T')[0];
      
      try {
        const { error: temuanError } = await supabase
          .from('temuan')
          .insert([{
            id,
            tanggal_temuan: tanggal,
            nama_mesin: namaMesin,
            operator,
            kategori_temuan: kategori,
            item_temuan: item,
            dampak_masalah: dampak,
            foto_before: fotoBefore,
            saran_action: saran,
            status: 'open',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }]);
        
        if (temuanError) throw temuanError;
        
        const { error: historyError } = await supabase
          .from('history')
          .insert([{
            timestamp: new Date().toISOString(),
            action: 'Temuan Baru',
            details: `Temuan "${item}" ditambahkan pada mesin ${namaMesin} oleh ${operator}`
          }]);
        
        if (historyError) throw historyError;
        
        showNotification('Temuan berhasil disimpan', 'success');
        resetForm();
        await loadData();
        await loadMachineOptions();
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="dashboard"]').classList.add('active');
        document.getElementById('dashboard').classList.add('active');
      } catch (error) {
        console.error('Error saving:', error);
        showNotification('Gagal menyimpan temuan');
      }
    }
    
    function resetForm() {
      document.getElementById('input-form').reset();
      document.getElementById('preview-before').style.display = 'none';
      document.getElementById('input-mesin-baru').value = '';
    }
    
    function openUpdateModal(id) {
      document.getElementById('update-id').value = id;
      document.getElementById('update-modal').classList.add('active');
      document.getElementById('update-form').reset();
      document.getElementById('preview-after').style.display = 'none';
    }
    
    function closeUpdateModal() {
      document.getElementById('update-modal').classList.remove('active');
    }
    
    async function handleUpdateTemuan(e) {
      e.preventDefault();
      
      const id = document.getElementById('update-id').value;
      const action = document.getElementById('update-action').value;
      const pic = document.getElementById('update-pic').value.toUpperCase();
      const fotoAfter = document.getElementById('preview-after').src;
      
      if (!fotoAfter || fotoAfter === window.location.href) {
        showNotification('Foto after harus diupload');
        return;
      }
      
      try {
        const temuan = allData.find(d => d.id === id);
        
        const { error: updateError } = await supabase
          .from('temuan')
          .update({
            action,
            foto_after: fotoAfter,
            inisial_pic: pic,
            status: 'closed',
            updated_at: new Date().toISOString()
          })
          .eq('id', id);
        
        if (updateError) throw updateError;
        
        const { error: historyError } = await supabase
          .from('history')
          .insert([{
            timestamp: new Date().toISOString(),
            action: 'Update Status',
            details: `Temuan "${temuan.item_temuan}" di mesin ${temuan.nama_mesin} telah closed oleh ${pic}`
          }]);
        
        if (historyError) throw historyError;
        
        showNotification('Temuan berhasil di-update', 'success');
        closeUpdateModal();
        await loadData();
      } catch (error) {
        console.error('Error updating:', error);
        showNotification('Gagal update temuan');
      }
    }
    
    async function loadHistory() {
      try {
        const { data, error } = await supabase
          .from('history')
          .select('*')
          .order('timestamp', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('timeline-container');
        
        if (!data || data.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 16px;">üìú</div>
              <div style="font-size: 16px; font-weight: 600;">Belum ada riwayat</div>
              <div style="font-size: 14px; margin-top: 8px;">Aktivitas akan muncul di sini</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = data.map(item => {
          const time = new Date(item.timestamp).toLocaleString('id-ID');
          return `
            <div class="timeline-item">
              <div class="timeline-time">${time}</div>
              <div class="timeline-action">${item.action}</div>
              <div class="timeline-details">${item.details}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }
    
    function showImage(src) {
      document.getElementById('modal-image').src = src;
      document.getElementById('image-modal').classList.add('active');
    }
    
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notification-text');
      
      text.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Initialize app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a877dbd22629b07',t:'MTc2NDgxMTMzMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
