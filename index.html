<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communication Form</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    html {
      height: 100%;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-open {
      background-color: #fee2e2;
      color: #dc2626;
    }

    .status-closed {
      background-color: #d1fae5;
      color: #059669;
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }

    .filter-section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .auto-upper {
      text-transform: uppercase;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="app" style="height: 100%; overflow-y: auto; background: #f8fafc;"><!-- Header -->
   <div class="gradient-bg" style="padding: 24px; color: white;">
    <h1 id="app-title" style="margin: 0; font-size: 28px; font-weight: 700;">Communication Form</h1>
    <p style="margin: 8px 0 0 0; opacity: 0.9;">Sistem Monitoring Temuan dan Perbaikan</p>
   </div><!-- Tabs -->
   <div style="background: white; padding: 0 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);"><button class="tab-button active" data-tab="dashboard">üìä Dashboard</button> <button class="tab-button" data-tab="input">üìù Input Data</button> <button class="tab-button" data-tab="history">üìú History</button>
   </div><!-- Dashboard Tab -->
   <div id="dashboard-tab" class="tab-content" style="padding: 24px;"><!-- Filters -->
    <div class="filter-section">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="margin: 0; color: #1e293b; font-size: 18px;">üîç Filter Data</h3><button onclick="resetFilters()" class="btn-secondary" style="padding: 8px 16px; font-size: 14px;">üîÑ Reset Filter</button>
     </div>
     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
      <div><label style="display: block; margin-bottom: 6px; color: #475569; font-weight: 600;">Nama Mesin</label> <select id="filter-mesin"> <option value="">Semua Mesin</option> </select>
      </div>
      <div><label style="display: block; margin-bottom: 6px; color: #475569; font-weight: 600;">Tanggal Mulai</label> <input type="date" id="filter-tanggal-mulai">
      </div>
      <div><label style="display: block; margin-bottom: 6px; color: #475569; font-weight: 600;">Tanggal Akhir</label> <input type="date" id="filter-tanggal-akhir">
      </div>
      <div><label style="display: block; margin-bottom: 6px; color: #475569; font-weight: 600;">Operator</label> <select id="filter-operator"> <option value="">Semua Operator</option> </select>
      </div>
      <div><label style="display: block; margin-bottom: 6px; color: #475569; font-weight: 600;">Status</label> <select id="filter-status"> <option value="">Semua</option> <option value="open">Open</option> <option value="closed">Closed</option> </select>
      </div>
     </div>
    </div><!-- Score Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
     <div class="stat-card card-shadow" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 12px; color: white;">
      <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
       Total Temuan
      </div>
      <div id="stat-total" style="font-size: 36px; font-weight: 700;">
       0
      </div>
     </div>
     <div class="stat-card card-shadow" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 24px; border-radius: 12px; color: white;">
      <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
       Total Open
      </div>
      <div id="stat-open" style="font-size: 36px; font-weight: 700;">
       0
      </div>
     </div>
     <div class="stat-card card-shadow" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 24px; border-radius: 12px; color: white;">
      <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
       Total Closed
      </div>
      <div id="stat-closed" style="font-size: 36px; font-weight: 700;">
       0
      </div>
     </div>
     <div class="stat-card card-shadow" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 24px; border-radius: 12px; color: white;">
      <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
       Mesin Terinput
      </div>
      <div id="stat-mesin" style="font-size: 36px; font-weight: 700;">
       0
      </div>
     </div>
    </div><!-- Charts -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
     <div class="card-shadow" style="background: white; padding: 24px; border-radius: 12px;">
      <h3 style="margin: 0 0 16px 0; color: #1e293b;">üìà % Temuan per Mesin</h3>
      <div id="chart-temuan-mesin"></div>
     </div>
     <div class="card-shadow" style="background: white; padding: 24px; border-radius: 12px;">
      <h3 style="margin: 0 0 16px 0; color: #1e293b;">‚úÖ % Closed per Mesin</h3>
      <div id="chart-closed-mesin"></div>
     </div>
     <div class="card-shadow" style="background: white; padding: 24px; border-radius: 12px;">
      <h3 style="margin: 0 0 16px 0; color: #1e293b;">üë∑ Operator vs Temuan</h3>
      <div id="chart-operator-temuan"></div>
     </div>
    </div><!-- List Detail Temuan -->
    <div class="card-shadow" style="background: white; padding: 24px; border-radius: 12px;">
     <h3 style="margin: 0 0 16px 0; color: #1e293b;">üìã Detail Temuan</h3>
     <div id="temuan-list"></div>
    </div>
   </div><!-- Input Tab -->
   <div id="input-tab" class="tab-content" style="display: none; padding: 24px;">
    <div class="card-shadow" style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
     <h2 style="margin: 0 0 24px 0; color: #1e293b;">üìù Input Data Temuan Baru</h2>
     <form id="input-form">
      <div style="margin-bottom: 20px;"><label for="input-mesin" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Nama Mesin *</label> <input type="text" id="input-mesin-text" class="auto-upper" required placeholder="Contoh: MESIN-001"> <select id="input-mesin-select" required style="display: none;"> <option value="">Pilih Mesin</option> </select>
      </div>
      <div style="margin-bottom: 20px;"><label for="input-operator" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Inisial Operator *</label> <input type="text" id="input-operator" class="auto-upper" required placeholder="Contoh: JD">
      </div>
      <div style="margin-bottom: 20px;"><label for="input-kategori" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Kategori Temuan *</label> <select id="input-kategori" required> <option value="">Pilih Kategori</option> <option value="Quality">Quality</option> <option value="Productivity">Productivity</option> <option value="Safety">Safety</option> <option value="5R">5R</option> </select>
      </div>
      <div style="margin-bottom: 20px;"><label for="input-item" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Item Temuan *</label> <input type="text" id="input-item" class="auto-upper" required placeholder="Deskripsi temuan">
      </div>
      <div style="margin-bottom: 20px;"><label for="input-dampak" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Dampak Masalah *</label> <textarea id="input-dampak" class="auto-upper" required rows="3" placeholder="Jelaskan dampak dari masalah ini"></textarea>
      </div>
      <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Foto Before *</label> <input type="file" id="input-foto" accept="image/*" capture="environment" required style="display: none;"> <button type="button" onclick="document.getElementById('input-foto').click()" class="btn-secondary" style="width: 100%; margin-bottom: 12px;">üì∑ Pilih Foto</button>
       <div id="preview-foto-before" style="display: none; margin-top: 12px;"><img id="preview-foto-before-img" style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e2e8f0;"> <button type="button" onclick="clearFotoBefore()" class="btn-secondary" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">üóëÔ∏è Hapus</button>
       </div>
      </div>
      <div style="margin-bottom: 24px;"><label for="input-saran" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Saran Action *</label> <textarea id="input-saran" class="auto-upper" required rows="3" placeholder="Saran tindakan perbaikan"></textarea>
      </div><button type="submit" class="btn-primary" style="width: 100%;">üíæ Simpan Temuan</button>
     </form>
    </div>
   </div><!-- History Tab -->
   <div id="history-tab" class="tab-content" style="display: none; padding: 24px;">
    <div class="card-shadow" style="background: white; padding: 24px; border-radius: 12px;">
     <h2 style="margin: 0 0 20px 0; color: #1e293b;">üìú History Perubahan</h2>
     <div id="history-list"></div>
    </div>
   </div>
  </div><!-- Modal Update -->
  <div id="update-modal" style="display: none;"></div><!-- Modal Image Viewer -->
  <div id="image-modal" style="display: none;"></div>
  <script>
    const defaultConfig = {
      app_title: "Communication Form"
    };

    let allData = [];
    let historyData = [];

    // Supabase configuration
    const SUPABASE_URL = 'https://wlfadbreypyfakaxbwgh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZmFkYnJleXB5ZmFrYXhid2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTEyOTYsImV4cCI6MjA3OTUyNzI5Nn0.AsGijvZvcHXONrHSQQbwkrV_noBDOBAqRfJnG_T1aDE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Supabase functions
    async function loadFromSupabase() {
      try {
        // Load temuan data
        const { data: temuanData, error: temuanError } = await supabase
          .from('temuan')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (temuanError) throw temuanError;
        allData = temuanData || [];

        // Load history data
        const { data: historyDataResult, error: historyError } = await supabase
          .from('history')
          .select('*')
          .order('timestamp', { ascending: false });
        
        if (historyError) throw historyError;
        historyData = historyDataResult || [];
        
        renderDashboard();
        renderHistory();
        updateMesinInput();
        updateFilterDropdowns();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    async function saveTemuanToSupabase(temuan) {
      try {
        const { data, error } = await supabase
          .from('temuan')
          .insert([temuan])
          .select();
        
        if (error) throw error;
        return data;
      } catch (error) {
        console.error('Error saving temuan:', error);
        throw error;
      }
    }

    async function updateTemuanInSupabase(id, updates) {
      try {
        const { data, error } = await supabase
          .from('temuan')
          .update(updates)
          .eq('id', id)
          .select();
        
        if (error) throw error;
        return data;
      } catch (error) {
        console.error('Error updating temuan:', error);
        throw error;
      }
    }

    async function saveHistoryToSupabase(historyEntry) {
      try {
        const { data, error } = await supabase
          .from('history')
          .insert([historyEntry])
          .select();
        
        if (error) throw error;
        return data;
      } catch (error) {
        console.error('Error saving history:', error);
        throw error;
      }
    }

    function updateFilterDropdowns() {
      const filterMesin = document.getElementById('filter-mesin');
      const filterOperator = document.getElementById('filter-operator');
      
      const uniqueMesin = [...new Set(allData.map(item => item.nama_mesin))].sort();
      const uniqueOperator = [...new Set(allData.map(item => item.operator))].sort();
      
      const currentMesinValue = filterMesin.value;
      const currentOperatorValue = filterOperator.value;
      
      filterMesin.innerHTML = '<option value="">Semua Mesin</option>';
      uniqueMesin.forEach(mesin => {
        filterMesin.innerHTML += `<option value="${mesin}">${mesin}</option>`;
      });
      filterMesin.value = currentMesinValue;
      
      filterOperator.innerHTML = '<option value="">Semua Operator</option>';
      uniqueOperator.forEach(operator => {
        filterOperator.innerHTML += `<option value="${operator}">${operator}</option>`;
      });
      filterOperator.value = currentOperatorValue;
    }

    function updateMesinInput() {
      const textInput = document.getElementById('input-mesin-text');
      const selectInput = document.getElementById('input-mesin-select');
      
      if (allData.length === 0) {
        textInput.style.display = 'block';
        textInput.required = true;
        selectInput.style.display = 'none';
        selectInput.required = false;
      } else {
        const uniqueMesin = [...new Set(allData.map(item => item.nama_mesin))].sort();
        
        selectInput.innerHTML = '<option value="">Pilih Mesin atau Ketik Baru</option>';
        uniqueMesin.forEach(mesin => {
          selectInput.innerHTML += `<option value="${mesin}">${mesin}</option>`;
        });
        selectInput.innerHTML += '<option value="__new__">+ Tambah Mesin Baru</option>';
        
        selectInput.style.display = 'block';
        selectInput.required = true;
        textInput.style.display = 'none';
        textInput.required = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const selectInput = document.getElementById('input-mesin-select');
      const textInput = document.getElementById('input-mesin-text');
      
      selectInput.addEventListener('change', (e) => {
        if (e.target.value === '__new__') {
          selectInput.style.display = 'none';
          selectInput.required = false;
          textInput.style.display = 'block';
          textInput.required = true;
          textInput.value = '';
          textInput.focus();
        }
      });
      
      // Load data on page load
      loadFromSupabase();
    });

    function initApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const title = config.app_title || defaultConfig.app_title;
            document.getElementById('app-title').textContent = title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title]
          ])
        });

        const config = window.elementSdk?.config || defaultConfig;
        document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      }
    }

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.dataset.tab;
        
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        document.getElementById(`${tabName}-tab`).style.display = 'block';
      });
    });

    // Filter functionality
    ['filter-mesin', 'filter-tanggal-mulai', 'filter-tanggal-akhir', 'filter-operator', 'filter-status'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderDashboard);
      document.getElementById(id).addEventListener('change', renderDashboard);
    });

    // Reset filters function
    window.resetFilters = function() {
      document.getElementById('filter-mesin').value = '';
      document.getElementById('filter-tanggal-mulai').value = '';
      document.getElementById('filter-tanggal-akhir').value = '';
      document.getElementById('filter-operator').value = '';
      document.getElementById('filter-status').value = '';
      renderDashboard();
    };

    function getFilteredData() {
      const filterMesin = document.getElementById('filter-mesin').value;
      const filterTanggalMulai = document.getElementById('filter-tanggal-mulai').value;
      const filterTanggalAkhir = document.getElementById('filter-tanggal-akhir').value;
      const filterOperator = document.getElementById('filter-operator').value;
      const filterStatus = document.getElementById('filter-status').value;

      return allData.filter(item => {
        if (filterMesin && item.nama_mesin !== filterMesin) return false;
        if (filterOperator && item.operator !== filterOperator) return false;
        if (filterStatus && item.status !== filterStatus) return false;
        
        if (filterTanggalMulai || filterTanggalAkhir) {
          const itemDate = item.tanggal_temuan;
          if (filterTanggalMulai && itemDate < filterTanggalMulai) return false;
          if (filterTanggalAkhir && itemDate > filterTanggalAkhir) return false;
        }
        
        return true;
      });
    }

    function renderDashboard() {
      const filteredData = getFilteredData();
      
      const totalTemuan = filteredData.length;
      const totalOpen = filteredData.filter(item => item.status === 'open').length;
      const totalClosed = filteredData.filter(item => item.status === 'closed').length;
      const uniqueMesin = new Set(filteredData.map(item => item.nama_mesin)).size;

      document.getElementById('stat-total').textContent = totalTemuan;
      document.getElementById('stat-open').textContent = totalOpen;
      document.getElementById('stat-closed').textContent = totalClosed;
      document.getElementById('stat-mesin').textContent = uniqueMesin;

      renderCharts(filteredData);
      renderTemuanList(filteredData);
    }

    function renderCharts(data) {
      const temuanPerMesin = {};
      data.forEach(item => {
        temuanPerMesin[item.nama_mesin] = (temuanPerMesin[item.nama_mesin] || 0) + 1;
      });

      let chartHTML = '';
      const total = data.length;
      Object.entries(temuanPerMesin).forEach(([mesin, count]) => {
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        chartHTML += `
          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span style="font-weight: 600; color: #475569;">${mesin}</span>
              <span style="color: #667eea; font-weight: 600;">${percentage}%</span>
            </div>
            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
            </div>
          </div>
        `;
      });
      document.getElementById('chart-temuan-mesin').innerHTML = chartHTML || '<p style="color: #94a3b8; text-align: center;">Tidak ada data</p>';

      const closedPerMesin = {};
      data.forEach(item => {
        if (!closedPerMesin[item.nama_mesin]) {
          closedPerMesin[item.nama_mesin] = { total: 0, closed: 0 };
        }
        closedPerMesin[item.nama_mesin].total++;
        if (item.status === 'closed') {
          closedPerMesin[item.nama_mesin].closed++;
        }
      });

      chartHTML = '';
      Object.entries(closedPerMesin).forEach(([mesin, stats]) => {
        const percentage = stats.total > 0 ? ((stats.closed / stats.total) * 100).toFixed(1) : 0;
        chartHTML += `
          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span style="font-weight: 600; color: #475569;">${mesin}</span>
              <span style="color: #059669; font-weight: 600;">${percentage}%</span>
            </div>
            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #43e97b, #38f9d7); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
            </div>
          </div>
        `;
      });
      document.getElementById('chart-closed-mesin').innerHTML = chartHTML || '<p style="color: #94a3b8; text-align: center;">Tidak ada data</p>';

      const operatorTemuan = {};
      data.forEach(item => {
        operatorTemuan[item.operator] = (operatorTemuan[item.operator] || 0) + 1;
      });

      chartHTML = '';
      Object.entries(operatorTemuan).forEach(([operator, count]) => {
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        chartHTML += `
          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span style="font-weight: 600; color: #475569;">${operator}</span>
              <span style="color: #f5576c; font-weight: 600;">${count} (${percentage}%)</span>
            </div>
            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
            </div>
          </div>
        `;
      });
      document.getElementById('chart-operator-temuan').innerHTML = chartHTML || '<p style="color: #94a3b8; text-align: center;">Tidak ada data</p>';
    }

    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('id-ID', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderTemuanList(data) {
      const listContainer = document.getElementById('temuan-list');
      
      if (data.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">Tidak ada temuan ditemukan</p>';
        return;
      }

      let html = '<div style="overflow-x: auto;">';
      html += '<table style="width: 100%; border-collapse: collapse; min-width: 1400px;">';
      html += `
        <thead>
          <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Status</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Tanggal Temuan</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Tanggal Update</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Mesin</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Operator</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Kategori</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Item Temuan</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Dampak</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Saran Action</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Action</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">PIC</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Foto</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Aksi</th>
          </tr>
        </thead>
        <tbody>
      `;

      data.forEach(item => {
        const statusClass = item.status === 'open' ? 'status-open' : 'status-closed';
        const statusText = item.status === 'open' ? 'üî¥ OPEN' : 'üü¢ CLOSED';
        
        html += `
          <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 12px;"><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td style="padding: 12px; color: #64748b;">${item.tanggal_temuan}</td>
            <td style="padding: 12px; color: #64748b; font-size: 13px;">${formatDateTime(item.updated_at)}</td>
            <td style="padding: 12px; font-weight: 600; color: #1e293b;">${item.nama_mesin}</td>
            <td style="padding: 12px; color: #64748b;">${item.operator}</td>
            <td style="padding: 12px;"><span style="background: #ddd6fe; color: #7c3aed; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${item.kategori_temuan}</span></td>
            <td style="padding: 12px; color: #475569;">${item.item_temuan}</td>
            <td style="padding: 12px; color: #64748b; max-width: 200px;">${item.dampak_masalah}</td>
            <td style="padding: 12px; color: #64748b; max-width: 200px;">${item.saran_action}</td>
            <td style="padding: 12px; color: #64748b;">${item.action || '-'}</td>
            <td style="padding: 12px; color: #64748b;">${item.inisial_pic || '-'}</td>
            <td style="padding: 12px;">
              <div style="display: flex; gap: 8px; align-items: center;">
                ${item.foto_before ? `
                  <div style="text-align: center;">
                    <img src="${item.foto_before}" onclick="showImageModal('${item.id}', 'before')" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Before</div>
                  </div>
                ` : '<div style="width: 80px; text-align: center; color: #94a3b8;">-</div>'}
                ${item.foto_after ? `
                  <div style="text-align: center;">
                    <img src="${item.foto_after}" onclick="showImageModal('${item.id}', 'after')" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">After</div>
                  </div>
                ` : ''}
              </div>
            </td>
            <td style="padding: 12px;">
              ${item.status === 'open' ? `<button onclick="openUpdateModal('${item.id}')" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">Update</button>` : '-'}
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      listContainer.innerHTML = html;
    }

    function renderHistory() {
      const historyContainer = document.getElementById('history-list');
      
      if (historyData.length === 0) {
        historyContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">Belum ada history perubahan</p>';
        return;
      }

      let html = '';
      historyData.forEach((entry, index) => {
        html += `
          <div style="border-left: 3px solid #667eea; padding-left: 20px; margin-bottom: 20px; position: relative;">
            <div style="position: absolute; left: -8px; top: 0; width: 12px; height: 12px; background: #667eea; border-radius: 50%;"></div>
            <div style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">${new Date(entry.timestamp).toLocaleString('id-ID')}</div>
            <div style="color: #1e293b; font-weight: 600; margin-bottom: 4px;">${entry.action}</div>
            <div style="color: #64748b; font-size: 14px;">${entry.details}</div>
          </div>
        `;
      });

      historyContainer.innerHTML = html;
    }

    window.openUpdateModal = function(itemId) {
      const item = allData.find(d => d.id === itemId);
      if (!item) return;

      const modalHTML = `
        <div class="modal-overlay">
          <div class="modal-content">
            <h2 style="margin: 0 0 24px 0; color: #1e293b;">Update Temuan</h2>
            <form id="update-form">
              <div style="margin-bottom: 20px;">
                <label for="update-action" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Action yang Dilakukan *</label>
                <textarea id="update-action" class="auto-upper" required rows="3" placeholder="Jelaskan tindakan yang telah dilakukan"></textarea>
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Foto After *</label>
                <input type="file" id="update-foto-after" accept="image/*" capture="environment" required style="display: none;">
                <button type="button" onclick="document.getElementById('update-foto-after').click()" class="btn-secondary" style="width: 100%; margin-bottom: 12px;">üì∑ Pilih Foto</button>
                <div id="preview-foto-after" style="display: none; margin-top: 12px;">
                  <img id="preview-foto-after-img" style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <button type="button" onclick="clearFotoAfter()" class="btn-secondary" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">üóëÔ∏è Hapus</button>
                </div>
              </div>
              <div style="margin-bottom: 24px;">
                <label for="update-pic" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600;">Inisial PIC Perbaikan *</label>
                <input type="text" id="update-pic" class="auto-upper" required placeholder="Contoh: AB">
              </div>
              <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn-primary" style="flex: 1;">üíæ Simpan</button>
                <button type="button" onclick="closeUpdateModal()" class="btn-secondary" style="flex: 1;">Batal</button>
              </div>
            </form>
          </div>
        </div>
      `;

      const modalContainer = document.getElementById('update-modal');
      modalContainer.innerHTML = modalHTML;
      modalContainer.style.display = 'block';

      document.getElementById('update-foto-after').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (file) {
          const compressed = await compressImage(file);
          document.getElementById('preview-foto-after-img').src = compressed;
          document.getElementById('preview-foto-after').style.display = 'block';
        }
      });

      window.clearFotoAfter = function() {
        document.getElementById('update-foto-after').value = '';
        document.getElementById('preview-foto-after').style.display = 'none';
        document.getElementById('preview-foto-after-img').src = '';
      };

      document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const button = e.target.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '‚è≥ Menyimpan...';
        
        try {
          const action = document.getElementById('update-action').value;
          const inisialPic = document.getElementById('update-pic').value.toUpperCase();
          
          const fotoAfterInput = document.getElementById('update-foto-after');
          let fotoAfterData = '';
          
          if (fotoAfterInput.files && fotoAfterInput.files[0]) {
            fotoAfterData = await compressImage(fotoAfterInput.files[0]);
          }

          const updates = {
            action,
            foto_after: fotoAfterData,
            inisial_pic: inisialPic,
            status: 'closed',
            updated_at: new Date().toISOString()
          };

          await updateTemuanInSupabase(item.id, updates);
          
          const historyEntry = {
            timestamp: new Date().toISOString(),
            action: 'Update Status',
            details: `Temuan "${item.item_temuan}" pada mesin ${item.nama_mesin} telah di-closed oleh ${inisialPic}`
          };
          
          await saveHistoryToSupabase(historyEntry);
          await loadFromSupabase();
          closeUpdateModal();
        } catch (error) {
          console.error('Error updating:', error);
          button.disabled = false;
          button.textContent = originalText;
        }
      });
    };

    window.closeUpdateModal = function() {
      const modalContainer = document.getElementById('update-modal');
      modalContainer.style.display = 'none';
      modalContainer.innerHTML = '';
    };

    function compressImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('input-foto').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (file) {
        const compressed = await compressImage(file);
        document.getElementById('preview-foto-before-img').src = compressed;
        document.getElementById('preview-foto-before').style.display = 'block';
      }
    });

    window.clearFotoBefore = function() {
      document.getElementById('input-foto').value = '';
      document.getElementById('preview-foto-before').style.display = 'none';
      document.getElementById('preview-foto-before-img').src = '';
    };

    window.showImageModal = function(itemId, type) {
      const item = allData.find(d => d.id === itemId);
      if (!item) return;
      
      const imageSrc = type === 'before' ? item.foto_before : item.foto_after;
      const title = type === 'before' ? 'Before' : 'After';
      
      const modalHTML = `
        <div class="modal-overlay" onclick="closeImageModal()">
          <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h2 style="margin: 0; color: #1e293b;">üì∑ Foto ${title}</h2>
              <button onclick="closeImageModal()" class="btn-secondary" style="padding: 8px 16px;">‚úï Tutup</button>
            </div>
            <img src="${imageSrc}" style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e2e8f0;">
          </div>
        </div>
      `;
      
      const modalContainer = document.getElementById('image-modal');
      modalContainer.innerHTML = modalHTML;
      modalContainer.style.display = 'block';
    };

    window.closeImageModal = function() {
      const modalContainer = document.getElementById('image-modal');
      modalContainer.style.display = 'none';
      modalContainer.innerHTML = '';
    };

    document.getElementById('input-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const textInput = document.getElementById('input-mesin-text');
      const selectInput = document.getElementById('input-mesin-select');
      
      let namaMesin = '';
      
      if (textInput.style.display !== 'none') {
        namaMesin = textInput.value.trim().toUpperCase();
      } else {
        namaMesin = selectInput.value;
      }

      if (!namaMesin || namaMesin === '__new__') {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600;';
        errorDiv.textContent = '‚ö†Ô∏è Nama mesin harus diisi!';
        e.target.insertBefore(errorDiv, e.target.firstChild);
        setTimeout(() => errorDiv.remove(), 3000);
        return;
      }

      const button = e.target.querySelector('button[type="submit"]');
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = '‚è≥ Menyimpan...';

      try {
        const fotoInput = document.getElementById('input-foto');
        let fotoBeforeData = '';
        
        if (fotoInput.files && fotoInput.files[0]) {
          fotoBeforeData = await compressImage(fotoInput.files[0]);
        }

        const newTemuan = {
          id: 'TMN-' + Date.now(),
          tanggal_temuan: new Date().toISOString().split('T')[0],
          nama_mesin: namaMesin,
          operator: document.getElementById('input-operator').value.toUpperCase(),
          kategori_temuan: document.getElementById('input-kategori').value,
          item_temuan: document.getElementById('input-item').value.toUpperCase(),
          dampak_masalah: document.getElementById('input-dampak').value.toUpperCase(),
          foto_before: fotoBeforeData,
          saran_action: document.getElementById('input-saran').value.toUpperCase(),
          action: '',
          status: 'open',
          inisial_pic: '',
          foto_after: '',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        await saveTemuanToSupabase(newTemuan);
        
        const historyEntry = {
          timestamp: new Date().toISOString(),
          action: 'Temuan Baru',
          details: `Temuan "${newTemuan.item_temuan}" ditambahkan pada mesin ${newTemuan.nama_mesin} oleh ${newTemuan.operator}`
        };
        
        await saveHistoryToSupabase(historyEntry);
        await loadFromSupabase();

        e.target.reset();
        document.getElementById('preview-foto-before').style.display = 'none';
        
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'background: #d1fae5; color: #059669; padding: 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600;';
        successDiv.textContent = '‚úÖ Temuan berhasil disimpan!';
        e.target.insertBefore(successDiv, e.target.firstChild);
        
        setTimeout(() => {
          successDiv.remove();
          document.querySelector('[data-tab="dashboard"]').click();
        }, 2000);

        button.disabled = false;
        button.textContent = originalText;
      } catch (error) {
        console.error('Error saving:', error);
        
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600;';
        errorDiv.textContent = '‚ùå Gagal menyimpan temuan!';
        e.target.insertBefore(errorDiv, e.target.firstChild);
        setTimeout(() => errorDiv.remove(), 3000);
        
        button.disabled = false;
        button.textContent = originalText;
      }
    });

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a35af3eb2b9fde2',t:'MTc2Mzk1MzUyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
